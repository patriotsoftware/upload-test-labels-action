name: upload-test-labels
author: Data
description: Parse test labels in a project and upload them to S3 to be ingested to the data warehouse

inputs:
  repository_name:
    description: The name of the repository in which to parse test labels
    required: true
  projects:
    description: The projects containing tests to parse. Full path to the dll, comma separated.
    required: true 

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "7.0.x"
        source-url: https://nuget.pkg.github.com/SynergyDataSystems/index.json
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.CUSTOM_GITHUB_ACCESS_TOKEN }}
        
    - name: Authenticate with DBA
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.DBA_AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.DBA_AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Restore NuGet Packages
      run: nuget restore TestLabelReporting.sln

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v2
          
    - name: Build Test Label Export Utility
      run: msbuild TestLabelReporting.sln /p:Configuration="Production" /p:OutputPath="\bin\artifacts"

    - name: Run Test Label Export Utility
      run: |
       \bin\artifacts\TestLabelReporting.exe ${{ inputs.repository_name }} ${{ inputs.projects }}